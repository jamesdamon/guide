

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>BibSched Admin Guide &mdash; tind-doc 1.0.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="tind-doc 1.0.0 documentation" href="../index.html"/>
        <link rel="up" title="Guide for System Administrators" href="index.html"/>
        <link rel="next" title="BibSort Admin Guide" href="bibsort-admin-guide.html"/>
        <link rel="prev" title="BibRank Admin Guide" href="bibrank-admin-guide.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="fa fa-home"> tind-doc</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../librarian/index.html">Guide for Librarians</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../librarian/create-collection.html">Create Collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../librarian/export-xml.html">Export data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../librarian/restrict-documents.html">Make documents restricted</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Guide for System Administrators</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="bibauthority-admin-guide.html">BibAuthority Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibcheck-admin-guide.html">BibCheck Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibcirculation-admin-guide.html">BibCirculation Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibclassify-admin-guide.html">BibClassify Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibconvert-admin-guide.html">BibConvert Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibedit-admin-guide.html">BibEdit Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibexport-admin-guide.html">BibExport Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibformat-admin-guide.html">BibFormat Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibindex-admin-guide.html">BibIndex Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibknowledge-admin-guide.html">BibKnowledge Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibmatch-admin-guide.html">BibMatch Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibrank-admin-guide.html">BibRank Admin Guide</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">BibSched Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibsort-admin-guide.html">BibSort Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibsword-client-admin-guide.html">BibSword client Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="bibupload-admin-guide.html">BibUpload Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="docextract-admin-guide.html">DocExtract Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="elmsubmit-admin-guide.html">ElmSubmit Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="oaiharvest-admin-guide.html">OAIHarvest Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="oairepository-admin-guide.html">OAIRepository Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="publiline-admin-guide.html">Publiline Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="webcomment-admin-guide.html">WebComment Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="webjournal-admin-guide.html">WebJournal Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="webjournal-editor-guide.html">WebJournal Editor Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="webmessage-admin-guide.html">WebMessage Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="websearch-admin-guide.html">WebSearch Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="websession-admin-guide.html">WebSession Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="webstat-admin-guide.html">WebStat Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="webstyle-admin-guide.html">WebStyle Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="websubmit-admin-guide.html">WebSubmit Admin Guide</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Guide for tools.tind.io</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/xml-manipulation.html">XML Manipulation</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../doc/index.html">Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../doc/intro.html">MARC intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc/docguide.html">Site template</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doc/use-of-marc.html">MARC Fields</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">tind-doc</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Guide for System Administrators</a> &raquo;</li>
      
    <li>BibSched Admin Guide</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../_sources/admin/bibsched-admin-guide.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="bibsched-admin-guide">
<span id="id1"></span><h1>BibSched Admin Guide<a class="headerlink" href="#bibsched-admin-guide" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>BibSched &#8211; the bibliographic task scheduler &#8211; is central unit of the
system that allows all other modules to access the bibliographic
database in a controlled manner, preventing sharing violation threats
and assuring the coherent execution of the database update tasks. The
module comes with an administrative interface that allows to monitor the
task queue including various possibilities of a manual intervention, for
example to re-schedule queued tasks, change the task order, etc.</p>
<p>You can run the administrative interface by doing:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>$ bibsched
</pre></div>
</div>
</div></blockquote>
<p>Note that in general you should run bibsched with the same rights of the
Apache user of your system.</p>
<p>The <tt class="docutils literal"><span class="pre">bibsched</span></tt> can run in two modes: <em>automatic</em> and <em>manual</em>. In the
automatic mode, it will execute tasks automatically as they arrive in
the waiting queue. In the manual mode, the administrator has to launch
the tasks manually.</p>
</div>
<div class="section" id="bibsched-graphical-interface">
<h2>Bibsched graphical interface<a class="headerlink" href="#bibsched-graphical-interface" title="Permalink to this headline">¶</a></h2>
<p>bibsched interface is text mode graphical interface to display running
tasks. It has three views, one for listing done tasks, one for
scheduled/running/failed tasks and a third one for displaying archived
tasks. You can switch among these three views by pressing respectively
&#8220;<tt class="docutils literal"><span class="pre">1</span></tt>&#8221;, &#8220;<tt class="docutils literal"><span class="pre">2</span></tt>&#8221; or &#8220;<tt class="docutils literal"><span class="pre">3</span></tt>&#8221;.</p>
<p>With the harrows you can move from one task to the other</p>
<p>By pressing &#8220;<tt class="docutils literal"><span class="pre">O</span></tt>&#8221; you can see all the details of the selected task</p>
<p>If the task is running or is already run, you can press &#8220;l&#8221; (lower case
&#8220;<tt class="docutils literal"><span class="pre">l</span></tt>&#8221;) to access the standard output produced by the task, if any.
You can press &#8220;<tt class="docutils literal"><span class="pre">L</span></tt>&#8221; (upper case &#8220;<tt class="docutils literal"><span class="pre">L</span></tt>&#8221;) to access the standard
error produced by the task, if any.</p>
<p>By pressing &#8220;<tt class="docutils literal"><span class="pre">P</span></tt>&#8221; you can clean the list of DONE tasks and
archive/delete them.</p>
<p>By pressing &#8220;<tt class="docutils literal"><span class="pre">Q</span></tt>&#8221; you can Quit the interface.</p>
<p>By pressing &#8220;<tt class="docutils literal"><span class="pre">A</span></tt>&#8221; you can switch from Auto to Manual mode and
viceversa.</p>
<div class="section" id="manual-mode">
<h3>Manual mode<a class="headerlink" href="#manual-mode" title="Permalink to this headline">¶</a></h3>
<p>In manual mode, depending on the status of the task you are currently
selecting you&#8217;re given different actions.</p>
<p>You can press &#8220;<tt class="docutils literal"><span class="pre">R</span></tt>&#8221; for running Waiting tasks</p>
<p>You can press &#8220;<tt class="docutils literal"><span class="pre">D</span></tt>&#8221; for deleting non running tasks</p>
<p>You can press &#8220;<tt class="docutils literal"><span class="pre">N</span></tt>&#8221; for changing the priority of a waiting task.
(the equivalent of the UNIX renice command)</p>
<p>On a running task you can press &#8220;<tt class="docutils literal"><span class="pre">K</span></tt>&#8221; to kill the task immediately
in case of emergency. &#8220;<tt class="docutils literal"><span class="pre">T</span></tt>&#8221; for stopping it cleanly. &#8220;<tt class="docutils literal"><span class="pre">S</span></tt>&#8221; for
putting it temporarily to sleep. A sleeping task can be waken up by
pressing &#8220;<tt class="docutils literal"><span class="pre">W</span></tt>&#8221;. Note that for stopping or putting to sleep a task, a
signal is sent to the given bibtask and this, in turn, will acknowledge
it and decide to stop or go to sleep whenever it thinks it&#8217;s safe.</p>
<p>On a failed task you can press &#8220;<tt class="docutils literal"><span class="pre">K</span></tt>&#8221; the acknowledge the error. This
is necessary in case you wish to put bibsched back to automatic mode.</p>
</div>
<div class="section" id="automatic-mode">
<h3>Automatic mode<a class="headerlink" href="#automatic-mode" title="Permalink to this headline">¶</a></h3>
<p>In automatic mode bibsched will take care of launching tasks based on
their priority and runtime schedule. The available option are only those
that allow you to query a given task (see the logs and the options).</p>
<p>If you have configured bibsched to allow for the execution of concurrent
bibtasks, bibsched will take care of launching compatible tasks
concurrently (note that this feature is currently experimental).
Bibupload tasks will always be executed in the chronological order (to
preserve input consistency).</p>
</div>
</div>
<div class="section" id="bibsched-maintenance">
<h2>Bibsched maintenance<a class="headerlink" href="#bibsched-maintenance" title="Permalink to this headline">¶</a></h2>
<p>bibsched produce two log files. bibsched.log and bibsched.err, located
under the usual log directory of your Invenio installation. The former
will contain all the actions (either automatic of manual) that bibsched
has performed. The latter will contain all the exceptional errors.</p>
<p>In case of a bibtask failing while bibsched is in automatic mode,
bibsched will stop by switching to manual mode, and will send an email
to the administrator (and an emergency SMS in case it is configured to
do so). Note that in case of failed bibtasks, bibsched will refuse to be
put back to automatic mode, until either the task is reinitialized, or
deleted or the error is acknowledged.</p>
</div>
<div class="section" id="priorities">
<h2>Priorities<a class="headerlink" href="#priorities" title="Permalink to this headline">¶</a></h2>
<p>A task can be scheduled with a given <em>priority</em>, represented by an
integer number. When at a given time two or more tasks might be
executed, the task with higher priority will be executed first.</p>
<p>When a task is running and is not a bibupload, the scheduler will allow
to run higher priority tasks that don&#8217;t conflict with the former task,
by first putting to sleep the former task, if the resources are not
enough.</p>
<p>If a task has priority higher than 100 and there are currently other
task running, conflicting with the execution of this task (because the
other tasks should not run concurrently with this task), then the other
tasks are stopped (unless they are bibuploads).</p>
<p>If the priority is less than -10 than the task will never be executed
automatically.</p>
<p>Bibupload tasks are not affected by priority with respect to each other
and will always be executed in the proper order.</p>
</div>
<div class="section" id="task-logging">
<h2>Task logging<a class="headerlink" href="#task-logging" title="Permalink to this headline">¶</a></h2>
<p>When executed each tasks will produced (if necessary) a couple of log
files. One called <tt class="docutils literal"><span class="pre">bibsched_task_{task_id}.log</span></tt> and the other
<tt class="docutils literal"><span class="pre">bibsched_task_{task_id}.err</span></tt>. In case of reschedulable task, each
time the task is rescheduled it is being assigned the same task_id.
That means that log information of successive execution of the given
task will be appended at the end of already existing log files.</p>
<p>A log-rotation algorithm is applied when writing into the log file. By
default each log will be no bigger than 1MB. After this limit is reached
the log is rotated. Note that when viewing the log file inside the
bibsched monitor interface, only the latest log will be displayed.</p>
</div>
<div class="section" id="task-concurrency">
<h2>Task concurrency<a class="headerlink" href="#task-concurrency" title="Permalink to this headline">¶</a></h2>
<p>A recent experimental feature of bibsched is the concurrent execution of
compatible tasks. The current definition of when two tasks are
considered compatible is: &#8220;If a two tasks have the same name (e.g.
bibupload) then they&#8217;re incompatible.&#8221;</p>
<p>Sometimes you might want to consider compatible two tasks even when they
have the same name. For this you can add a name specification via the
bibtask command line option <tt class="docutils literal"><span class="pre">--name</span></tt>. E.g. you might want to
distinguish a generic bibupload from a bibupload carrying only
preformatting information. For this just launch bibupload -N
&#8220;bibformat&#8221;, and it will be considered compatible with all the other
bibuploads.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>Bibsched can be tweaked by adjusting some variables in the usual
<tt class="docutils literal"><span class="pre">invenio(-local).conf</span></tt> file. Please refer to the documentation
associated with each variable inside this file.</p>
</div>
<div class="section" id="bibsched-command-line-interface">
<h2>Bibsched command line interface<a class="headerlink" href="#bibsched-command-line-interface" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre>Usage: /opt/invenio/bin/bibsched [options] [start|stop|restart|monitor|status]

The following commands are available for bibsched:

start      start bibsched in background
stop       stop running bibtasks and the bibsched daemon safely
halt       halt running bibsched while keeping bibtasks running
restart    restart a running bibsched
monitor    enter the interactive monitor
status     get report about current status of the queue
purge      purge the scheduler queue from old tasks

Command options:
-d, --daemon           Launch BibSched in the daemon mode (deprecated, use &#39;start&#39;)
General options:
-h, --help             Print this help.
-V, --version          Print version information.
Status options:
-s, --status=LIST      Which BibTask status should be considered (default is Running,waiting)
-S, --since=TIME       Since how long time to consider tasks e.g.: 30m, 2h, 1d (default
is all)
-t, --tasks=LIST       Comma separated list of BibTask to consider (default
is all)
Purge options:
-s, --status=LIST      Which BibTask status should be considered (default is DONE)
-S, --since=TIME       Since how long time to consider tasks e.g.: 30m, 2h, 1d (default
is 30 days)
-t, --tasks=LIST       Comma separated list of BibTask to consider (default
is bibindex,bibreformat,webcoll,bibrank,inveniogc,bibupload,oairepositoryupdater)
</pre></div>
</div>
</div>
<div class="section" id="bibtasks-command-line-interface">
<h2>Bibtasks command line interface<a class="headerlink" href="#bibtasks-command-line-interface" title="Permalink to this headline">¶</a></h2>
<p>Each bibtask has a common command interface in addition to the proper
bibtask related options.</p>
<div class="highlight-python"><div class="highlight"><pre>Scheduling options:
-u, --user=USER       User name under which to submit this task.
-t, --runtime=TIME    Time to execute the task. [default=now]
                      Examples: +15s, 5m, 3h, 2002-10-27 13:57:26.
-s, --sleeptime=SLEEP Sleeping frequency after which to repeat the task.
                      Examples: 30m, 2h, 1d. [default=no]
--fixed-time          Avoid drifting of execution time when using --sleeptime
-I, --sequence-id=SEQUENCE-ID Sequence Id of the current process
-L  --limit=LIMIT     Time limit when it is allowed to execute the task.
                      Examples: 22:00-03:00, Sunday 01:00-05:00.
                      Syntax: [Wee[kday]] [hh[:mm][-hh[:mm]]].
-P, --priority=PRI    Task priority (0=default, 1=higher, etc).
-N, --name=NAME       Task specific name (advanced option).

General options:
-h, --help            Print this help.
-V, --version         Print version information.
-v, --verbose=LEVEL   Verbose level (0=min, 1=default, 9=max).
--profile=STATS       Print profile information. STATS is a comma-separated
                      list of desired output stats (calls, cumulative,
                      file, line, module, name, nfl, pcalls, stdname, time).
--stop-on-error       In case of unrecoverable error stop the bibsched queue.
--continue-on-error   In case of unrecoverable error don&#39;t stop the bibsched queue.
--post-process=BIB_TASKLET_NAME[parameters]   Postprocesses the specified
                      bibtasklet with the given parameters between square
                      brackets.
                      Example:--post-process &quot;bst_send_email[fromaddr=
                      &#39;foo@xxx.com&#39;, toaddr=&#39;bar@xxx.com&#39;, subject=&#39;hello&#39;,
                      content=&#39;help&#39;]&quot;
</pre></div>
</div>
</div>
<div class="section" id="bibsched-tasklets">
<h2>BibSched Tasklets<a class="headerlink" href="#bibsched-tasklets" title="Permalink to this headline">¶</a></h2>
<p>If you have very particular needs to write your self a bibtask that can
be scheduled through the bibliographic scheduler, and you are able to
write a Python function you can write a <strong>BibTaskLet</strong></p>
<p>Suppose that you have Python function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>that you want to execute through the bibliographic scheduler. Just put
such a function in the
<tt class="docutils literal"><span class="pre">/opt/cds-invenio/lib/python/invenio/bibsched_tasklets</span></tt> in a file
called e.g. <tt class="docutils literal"><span class="pre">bst_foo.py</span></tt> (the <em>bst_</em> prefix and the <em>.py</em> extension
are compulsory) and rename the function to <tt class="docutils literal"><span class="pre">bst_foo</span></tt> (the name of the
function must be identical to the name of the file).</p>
<p>A BibTaskLet can be executed through the <tt class="docutils literal"><span class="pre">bibtasklet</span></tt> BibTask. E.g.:</p>
<div class="highlight-python"><div class="highlight"><pre>$ # To list the available bibtasklets
$ sudo -u apache /opt/cds-invenio/bin/bibtasklet -l
Available tasklets:


╔══════════════════════════════════════════════════════════════════╗
║ def bst_fibonacci(n=30)                                          ║
╠══════════════════════════════════════════════════════════════════╣
║                                                                  ║
║     Small tasklets that prints the the Fibonacci sequence for n. ║
║     @param n: how many Fibonacci numbers to print.               ║
║     @type n: int                                                 ║
║                                                                  ║
╚══════════════════════════════════════════════════════════════════╝

╔════════════════════════════════════╗
║ def bst_foo(arg1, arg2=&#39;default&#39;)  ║
╠════════════════════════════════════╣
║                                    ║
║     No documentation.              ║
║                                    ║
╚════════════════════════════════════╝

Broken tasklets:

$ # To schedule a bibtasklet
$ sudo -u apache /opt/cds-invenio/bin/bibtasklet -T bst_foo -a &quot;arg1=bar&quot;
</pre></div>
</div>
<p>All the above bibtask options are available for any bibtasklet.</p>
<p>See
<tt class="docutils literal"><span class="pre">/opt/cds-invenio/lib/python/invenio/bibsched_tasklets/bst_fibonacci.py</span></tt>
for an example on how a bibtasklet look like.</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="bibsort-admin-guide.html" class="btn btn-neutral float-right" title="BibSort Admin Guide"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="bibrank-admin-guide.html" class="btn btn-neutral" title="BibRank Admin Guide"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Kenneth Hole.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>